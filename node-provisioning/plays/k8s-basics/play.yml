
#####################################
##
## This play will install k8s components,
## Args:
##    k8s_version: 1.35
##    token: <string>
##    discovery_token_ca_cert_hash: <string>
##    cp_ip: 192.168.0.1
##    provision_type: [worker | cp]
#####################################

- hosts: "{{_hosts}}"
  become: true
  tasks:
    # https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
    # This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
    - name: Adding yum repository for K8s
      template:
        src: files/kubernetes.repo
        dest: /etc/yum.repos.d/kubernetes.repo
        force: true
        owner: root
        group: root
        mode: '0644'

    - name: Install kubelet kubeadm kubectl
      dnf:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: latest
        disable_excludes: kubernetes

    - name: Enabling kubelet
      command: systemctl enable --now kubelet

    - name: Getting Hostname
      shell: echo $HOSTNAME
      register: hostname_output

    - name: Create working dir
      shell: mkdir -p /tmp/k8s

    - name: Configuring join template
      when: _hosts == "worker"
      vars:
        hostname: "{{hostname_output.stdout_lines.0}}"
      template:
        src: files/join.yml
        dest: /tmp/k8s/join.yml
        force: true
        owner: root
        group: root
        mode: '0644'

    - name: Joining cluster
      when: _hosts == "worker"
      command: kubeadm join --config /tmp/k8s/join.yml

    - name: Configuring create template
      when: _hosts == "cp"
      vars:
        hostname: "{{hostname_output.stdout_lines.0}}"
      template:
        src: files/create.yml
        dest: /tmp/k8s/create.yml
        force: true
        owner: root
        group: root
        mode: '0644'

    - name: Create cluster
      when: _hosts == "cp"
      command: kubeadm init --config=/tmp/k8s/create.yml

    - name: copying certs
      when: _hosts == "cp"
      shell: |
        mkdir -p $HOME/.kube
        cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        chown $(id -u):$(id -g) $HOME/.kube/config

    - name: Untainted the CP
      when: _hosts == "cp"
      command: kubectl taint nodes --all node-role.kubernetes.io/control-plane-

    - name: Downloading cilium
      when: _hosts == "cp"
      shell: |
        # https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-the-cilium-cli
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
        CLI_ARCH=amd64
        if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
        tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum} -f

    - name: Installing cilium
      when: _hosts == "cp"
      shell: |
        /usr/local/bin/cilium install --version 1.19.0 --set hubble.ui.enabled=true --set hubble.relay.enabled=true --set operator.replicas=1 --set hubble.relay.tls.server.enabled=false --set hubble.tls.enabled=false
